# ============================================================
# nginx.conf - Face Recognition Server v4.0
#
# Features:
# - Load balancing hacia múltiples instancias PM2
# - Rate limiting a nivel nginx (más eficiente que express-rate-limit)
# - Compression gzip para respuestas
# - Caché de respuestas para /health y /metrics
# - Headers de seguridad
# - HTTP/2 support
# - Timeouts optimizados para inferencia GPU (hasta 30s)
# ============================================================

user nginx;
worker_processes auto;
worker_rlimit_nofile 65535;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 4096;
    use epoll;
    multi_accept on;
}

http {
    include /etc/nginx/mime.types;
    default_type application/json;

    # ── Logging ──────────────────────────────────────────────
    log_format json_combined escape=json
        '{"time":"$time_iso8601",'
        '"method":"$request_method",'
        '"uri":"$request_uri",'
        '"status":$status,'
        '"body_bytes":$body_bytes_sent,'
        '"latency_ms":$upstream_response_time,'
        '"ip":"$remote_addr",'
        '"user_agent":"$http_user_agent"}';

    access_log /var/log/nginx/access.log json_combined;

    # ── Performance ───────────────────────────────────────────
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    keepalive_requests 1000;
    types_hash_max_size 2048;
    server_tokens off;

    # ── Compresión ────────────────────────────────────────────
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types application/json text/plain text/css application/javascript;
    gzip_min_length 1000;

    # ── Límites de body ───────────────────────────────────────
    # Imágenes base64 pueden ser grandes (hasta 50MB)
    client_max_body_size 60m;
    client_body_timeout 30s;
    client_header_timeout 15s;
    send_timeout 30s;

    # ── Rate Limiting ─────────────────────────────────────────
    # Zona de rate limiting por IP
    limit_req_zone $binary_remote_addr zone=api_limit:10m rate=30r/s;
    limit_req_zone $binary_remote_addr zone=recognize_limit:10m rate=10r/s;
    limit_req_zone $binary_remote_addr zone=register_limit:10m rate=5r/m;
    limit_req_status 429;

    # ── Upstream (backend Node.js) ────────────────────────────
    # Si usas PM2 cluster en el mismo server, todos los workers
    # escuchan en el mismo puerto y PM2 balancea internamente.
    # Para múltiples servidores, agregar aquí:
    upstream face_recognition_backend {
        least_conn;                         # Balanceo por conexiones activas
        server face-recognition:4350;       # Docker: nombre del servicio
        # server 127.0.0.1:4351;            # PM2: múltiples procesos en puertos distintos
        # server 127.0.0.1:4352;
        keepalive 32;                       # Conexiones keep-alive al backend
    }

    # ── Caché nginx ───────────────────────────────────────────
    proxy_cache_path /tmp/nginx-cache
        levels=1:2
        keys_zone=api_cache:10m
        max_size=100m
        inactive=60m
        use_temp_path=off;

    # ── Server principal ──────────────────────────────────────
    server {
        listen 80;
        listen [::]:80;
        server_name _;

        # Redirigir a HTTPS si tienes SSL configurado
        # return 301 https://$server_name$request_uri;

        # Headers de seguridad
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;

        # ── Health check (sin rate limiting, con caché) ───────
        location /health {
            proxy_pass http://face_recognition_backend;
            proxy_cache api_cache;
            proxy_cache_valid 200 10s;      # Cachear health por 10s
            proxy_cache_key "$scheme$host$uri";
            add_header X-Cache-Status $upstream_cache_status;

            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_connect_timeout 5s;
            proxy_read_timeout 10s;
        }

        # ── Métricas Prometheus (solo red interna idealmente) ─
        location /metrics {
            # allow 10.0.0.0/8;             # Solo red interna
            # allow 172.16.0.0/12;
            # deny all;

            proxy_pass http://face_recognition_backend;
            proxy_cache api_cache;
            proxy_cache_valid 200 15s;
            proxy_cache_key "$scheme$host$uri";

            proxy_http_version 1.1;
            proxy_set_header Connection "";
        }

        # ── API de reconocimiento (rate limiting estricto) ────
        location /api/recognition/recognize {
            limit_req zone=recognize_limit burst=20 nodelay;

            proxy_pass http://face_recognition_backend;
            include /etc/nginx/conf.d/proxy-params.conf;

            # Timeout extendido para inferencia GPU (hasta 30s)
            proxy_read_timeout 30s;
            proxy_send_timeout 30s;
        }

        # ── API de registro (más restrictivo) ─────────────────
        location /api/recognition/register {
            limit_req zone=register_limit burst=5 nodelay;

            proxy_pass http://face_recognition_backend;
            include /etc/nginx/conf.d/proxy-params.conf;

            proxy_read_timeout 60s;
        }

        # ── API de batch (timeout largo) ──────────────────────
        location /api/recognition/batch {
            limit_req zone=api_limit burst=10 nodelay;

            proxy_pass http://face_recognition_backend;
            include /etc/nginx/conf.d/proxy-params.conf;

            # Batch puede tardar más
            proxy_read_timeout 120s;
            proxy_send_timeout 120s;
        }

        # ── Resto de API ──────────────────────────────────────
        location /api/ {
            limit_req zone=api_limit burst=50 nodelay;

            proxy_pass http://face_recognition_backend;
            include /etc/nginx/conf.d/proxy-params.conf;

            proxy_read_timeout 30s;
        }

        # ── Archivos estáticos ────────────────────────────────
        location /models/ {
            proxy_pass http://face_recognition_backend;
            proxy_cache api_cache;
            proxy_cache_valid 200 1h;
            expires 1h;
            add_header Cache-Control "public, immutable";
        }
    }

    # ── HTTPS (descomentar cuando tengas SSL) ─────────────────
    # server {
    #     listen 443 ssl http2;
    #     server_name your-domain.com;
    #
    #     ssl_certificate /etc/nginx/ssl/cert.pem;
    #     ssl_certificate_key /etc/nginx/ssl/key.pem;
    #     ssl_protocols TLSv1.2 TLSv1.3;
    #     ssl_ciphers HIGH:!aNULL:!MD5;
    #     ssl_session_cache shared:SSL:10m;
    #
    #     # ... same locations as above
    # }
}
