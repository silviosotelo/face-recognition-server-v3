# ============================================================
# FACE RECOGNITION SERVER v4.0 - CONFIGURACIÓN
# ============================================================
# Copia este archivo como .env y ajusta los valores
# cp .env.example .env

# ============================================================
# SERVIDOR
# ============================================================
PORT=4350
NODE_ENV=production

# ============================================================
# BASE DE DATOS
# ============================================================
DB_PATH=./database.sqlite
DB_POOL_SIZE=10
DB_TIMEOUT=30000

# ============================================================
# ARCHIVOS Y UPLOADS
# ============================================================
MAX_FILE_SIZE=50mb
UPLOAD_PATH=./public/uploads
MODELS_PATH=./public/models

# ============================================================
# CORS Y SEGURIDAD
# ============================================================
ALLOWED_ORIGINS=*

# ============================================================
# CACHE (Redis + Fallback memoria)
# ============================================================
CACHE_ENABLED=true
CACHE_TTL=3600
CACHE_MAX_SIZE=1000

# Redis (distribuido, compartido entre workers PM2)
# Si no está configurado, usa node-cache en memoria como fallback
REDIS_URL=redis://localhost:6379
REDIS_PASSWORD=

# ============================================================
# LOGGING
# ============================================================
LOG_LEVEL=info
LOG_FILE=./logs/app.log

# ============================================================
# GPU / TENSORFLOW
# ============================================================

# TensorFlow permitirá crecimiento gradual de memoria GPU
# false = TF reserva TODA la VRAM al inicio (más rápido pero consume más)
# true  = TF reserva memoria según necesidad (recomendado para compartir GPU)
TF_FORCE_GPU_ALLOW_GROWTH=true

# Warmup de GPU al iniciar (true recomendado)
# Evita latencia alta en la primera solicitud de reconocimiento
GPU_WARMUP=true

# ============================================================
# RECONOCIMIENTO FACIAL - UMBRALES
# ============================================================

# Umbral principal de confianza (distancia euclidiana)
# Menor = más estricto, más seguro, menos falsos positivos
# Mayor = más permisivo, más matches, posibles falsos positivos
FACE_CONFIDENCE_THRESHOLD=0.42       # Recomendado: 0.38-0.45

FACE_DETECTION_CONFIDENCE=0.65       # Recomendado: 0.6-0.8
FACE_LANDMARK_CONFIDENCE=0.7         # Recomendado: 0.68-0.75

# ============================================================
# RECONOCIMIENTO FACIAL - TAMAÑOS
# ============================================================
FACE_MIN_SIZE=60                     # Mínimo píxeles de rostro (50-80)
FACE_MAX_SIZE=800                    # Máximo píxeles de rostro (600-1000)

# Resoluciones de entrada para los modelos
# GPU: puede usar resoluciones más altas (512-608) sin penalidad
# CPU: usar resoluciones menores (320-416) para velocidad
FACE_INPUT_SIZE_TINY=416             # TinyFaceDetector (CPU fallback): 320/416/512
FACE_INPUT_SIZE_SSD=512              # SsdMobilenetv1 (CPU): 416/512
FACE_INPUT_SIZE_SSD_GPU=608          # SsdMobilenetv1 (GPU): 512/608 (más preciso en GPU)
FACE_MAX_RESULTS=1                   # Máximo rostros a detectar por imagen

# ============================================================
# RECONOCIMIENTO FACIAL - POR TIPO DE OPERACIÓN
# ============================================================

# REGISTER (Alta precisión - se aplica solo una vez por persona)
REGISTER_CONFIDENCE=0.75
REGISTER_DETECTION_CONFIDENCE=0.8

# RECOGNIZE (Balanceado - alta frecuencia)
RECOGNIZE_CONFIDENCE=0.42
RECOGNIZE_DETECTION_CONFIDENCE=0.65

# PRECISE (Máxima precisión - para casos especiales)
PRECISE_CONFIDENCE=0.35
PRECISE_DETECTION_CONFIDENCE=0.7

# ============================================================
# TIMEOUTS Y PERFORMANCE
# ============================================================
FACE_DETECTION_TIMEOUT=10000         # Timeout detección (ms)
FACE_MODEL_LOAD_TIMEOUT=60000        # Timeout carga modelos (ms) - GPU necesita más tiempo

# ============================================================
# CALIDAD DE IMAGEN
# ============================================================
IMAGE_MIN_WIDTH=200
IMAGE_MIN_HEIGHT=200
IMAGE_MAX_WIDTH=2048
IMAGE_MAX_HEIGHT=2048
IMAGE_QUALITY=0.9

# ============================================================
# VALIDACIÓN FACIAL
# ============================================================
REQUIRE_LANDMARKS=true
REQUIRE_EXPRESSIONS=false
VALIDATE_FACE_AREA=true
VALIDATE_FACE_CLARITY=true

# ============================================================
# ÍNDICE HNSW (Búsqueda rápida O(log n))
# ============================================================
# El índice HNSW permite buscar en 1M+ caras en <10ms
# Se guarda en disco y se carga al iniciar el servidor

HNSW_INDEX_PATH=./data/hnsw.index
HNSW_META_PATH=./data/hnsw.meta.json

# ============================================================
# BATCH PROCESSING
# ============================================================
BATCH_MAX_SIZE=50                    # Máximo imágenes por lote
BATCH_CONCURRENCY=4                  # Imágenes procesadas en paralelo
BATCH_JOB_TTL_MS=3600000            # Tiempo de vida de jobs completados (1 hora)

# ============================================================
# CACHE ESPECÍFICO PARA RECONOCIMIENTO
# ============================================================
FACE_CACHE_ENABLED=true
FACE_CACHE_TTL=1800                  # 30 minutos
FACE_CACHE_MAX_USERS=500
